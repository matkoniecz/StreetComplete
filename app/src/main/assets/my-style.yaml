# license: GPLv3
# based on
# - reduced https://github.com/tangrams/cinnabar-style (MIT license)
# - https://raw.githubusercontent.com/tangrams/highways-demo/master/scene.yaml from https://github.com/tangrams/highways-demo seems a sane starting point (MIT license)
# https://mapzen.com/tangram/play/ used during development
# https://mapzen.com/documentation/vector-tiles/layers/ documentation of exposed data
#
# handle tile splitting https://mapzen.com/tangram/play/?#14.0000/54.1219/21.7292
#
# part of development blocked by missing data
# - access=* - see https://github.com/tilezen/vector-datasource/issues/1273
# - segregated on lower zoom levels - see https://github.com/tilezen/vector-datasource/issues/1316
# - poor bridge recognition - see https://github.com/tilezen/vector-datasource/issues/1314 ( after fixing that https://github.com/tangrams/cinnabar-style/issues/38 will be useful )
# - barrier=wall - see https://github.com/tilezen/vector-datasource/issues/1403
# - labels in local language - see https://github.com/tilezen/vector-datasource/issues/1406
# - low zoom labels - see https://github.com/tilezen/vector-datasource/issues/977
# lessons learned:
# 1) remember about both natural=wood and landuse=forest
global:
    earth_color: '#faf4f4'
    water_color: [0.27, 0.64, 0.9] # tone down green as you zoom out
    forest_color: [[10, '#b6e79f'], [14,  '#a4e187']]
    text_font_family: 'Open Sans'
    text_stroke_color: '#e4e1de'
    text_stroke: { color: global.text_stroke_color, width: [[1, 2px], [12, 3px],[16, 4px]] }
    text_fill_color: 'black'
    water_text_fill_color: [0.0, 0.2, 1.0]
    building_color: [.75, .75, .75]
    road_outline: '#9370db'
    good_road_color: [0.94, 0.84, 1.00]
    medium_road_color: [0.965, 0.92, 0.99, 1.00]
    bad_road_color: [0.83, 0.83, 0.83]
    pedestrian_color: global.good_road_color

    name_source: |
        function() {
            return feature['name:pl'] || feature.name;
        }

    bicycle_parking_text_source: |
        function() {
            return feature.capacity + " " + feature.operator;
        }

textures:
    pois:
        url: images/refill@2x.png
        filtering: mipmap
        sprites:
            bicycle_parking: [644, 126, 38, 38]
            arrow: [368, 210, 38, 38]

sources:
    # there is a tradeoff: larger tiles have a lower number of duplicated names, smaller ones
    # have less broken geometries
    mapzen:
        type: TopoJSON #GeoJSON, MVT, TopoJSON
        url:  https://tile.mapzen.com/mapzen/vector/v1/all/{z}/{x}/{y}.topojson
        max_zoom: 20
    mapzen_names:
        type: MVT #GeoJSON, MVT, TopoJSON
        url:  https://tile.mapzen.com/mapzen/vector/v1/all/{z}/{x}/{y}.mvt
        max_zoom: 20
        tile_size: 1024
camera:
    type: isometric

styles:
    icons:
        base: points
        texture: pois
        blend_order: 1

fonts:
    Open Sans:
        - weight: 300 # Light
          url: fonts/OpenSans-Light.woff
        - weight: normal # Regular
          url: fonts/OpenSans-Regular.woff
        - weight: normal # Regular
          style: italic
          url: fonts/OpenSans-Italic.woff
        - weight: 600 # Semi Bold
          url: fonts/OpenSans-Semibold.woff
        - weight: 600 # Semi Bold
          style: italic
          url: fonts/OpenSans-SemiboldItalic.woff
        - weight: bold
          url: fonts/OpenSans-Bold.woff

scene:
    background:
        color: global.earth_color

layers:
    landuse:
        data: { source: mapzen, layer: landuse }
        forested_area:
            filter: { kind: [park, forest, natural_wood], $zoom: { min: 11 }}
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: global.forest_color
        playgrounds:
            filter: { kind: [playground] }
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: [0.78, 0.97, 0.74]
        pitches:
            filter: { kind: [pitch] }
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: [0.97, 0.97, 0.74]

        pedestrian:
            filter:
                kind: [pedestrian,common,footway]
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: global.pedestrian_color

    path:
        data: { source: mapzen, layer: roads }
        filter:
            any:
                - { kind_detail: [footway, path, steps], not: { bicycle: designated }, not: { bicycle: yes }, $zoom: { min: 13 } }
                - { kind_detail: [pedestrian], not: { bicycle: designated }, not: { bicycle: yes }, $zoom: { min: 13 }}
        draw:
            lines:
                order: 1011
                color: global.pedestrian_color
                width: [[16, 0], [17, 2m]]
                cap: round
        walking_routes:
            filter: {walking_network: true}
            draw:
                lines:
                    width: [[1, 4px], [17, 2m]]

    roads:
        data: { source: mapzen, layer: roads }
        filter: { not: { kind_detail: service, kind: rail } }
        highway:
            filter:
                any:
                    - { kind: path, kind_detail: [footway, path], bicycle: designated }
                    - { kind: path, kind_detail: [footway, path], bicycle: yes }
                    - { kind: path, kind_detail: cycleway }
                    - { kind: path, kind_detail: track }
                    - { kind_detail: [pedestrian], bicycle: designated }
                    - { kind_detail: [pedestrian], bicycle: yes }
                    - kind: [highway, major_road, minor_road]
            draw:
                lines:
                    order: 1012
                    color: white
                    cap: round
                    width: [[1, 1.5px], [14, 2.5px], [16, 2.5px], [19, 6m]]
                    outline:
                        order: 1010
                        color: global.road_outline
                        width: [[14, 1px], [15, 1.5px]]
                        cap: butt
            highway_names:
                filter: { $zoom: { min: 16 } }
                draw:
                    text:
                        text_source: global.name_source
                        buffer: 3px
                        text_wrap: 25
                        max_lines: 3
                        font:
                            family: global.text_font_family
                            weight: normal
                            fill: [0.20, 0.20, 0.20]
                            size: [[16, 12px], [17, 13px], [19, 13px], [20, 14px]]
                            stroke: global.text_stroke
            tunnel:
                filter: {is_tunnel: true, $zoom: {min: 17} }
                draw:
                    lines:
                        outline:
                            width: [[17, 3px], [18, 4px]]
                            color: [0.5, 0.5, 0.5]
            good_surface:
                filter: {surface: [asphalt, paved, wood, metal, tartan, metal_grid]}
                draw:
                    lines:
                        color: global.good_road_color
                        order: 1015
            medium_surface:
                filter: {surface: [concrete, paving_stones, compacted, sett]}
                draw:
                    lines:
                        color: global.medium_road_color
                        order: 1014
            bad_surface:
                filter: {surface: [unpaved, dirt, earth, fine_gravel, grass, grass_paver, gravel,
                ground, mud, pebblestone, salt, sand, woodchips, clay, cobblestone,
                cobblestone_flattened, concrete_lanes, concrete_plates, artificial_turf, decoturf]}
                draw:
                    lines:
                        width: [[1, 0.5px], [14, 1.5px], [16, 1.5px], [19, 4m]]
                        color: global.bad_road_color
                        order: 1013
                        outline:
                            order: 1010
                            width: [[1, 0.5px], [16, 0.75px]]
            missing_surface:
                filter: {not: {surface: [asphalt, paved, wood, metal, tartan, metal_grid,
                concrete, paving_stones, compacted, sett,
                unpaved, dirt, earth, fine_gravel, grass, grass_paver, gravel,
                ground, mud, pebblestone, salt, sand, woodchips, clay, cobblestone,
                cobblestone_flattened, concrete_lanes, concrete_plates, artificial_turf, decoturf]}}
                draw:
                    lines:
                        width: [[1, 0.5px], [14, 1.5px], [16, 1.5px], [19, 5m]]
                        color: white
                        order: 1012
                        outline:
                            order: 1010
                            width: [[1, 0.5px], [16, 0.75px]]
            unimportant_service:
                filter: { service: [driveway, parking_aisle, 'drive-through'] }
                draw:
                    lines:
                        width: [[11, 0px], [13, 0.5px], [14, 1.5px], [16, 1.5px], [19, 5px]]
                        order: 1011
            unsegregated_or_use_sidepath:
                filter:
                    any:
                        - { kind: path, kind_detail: [footway], bicycle: [yes, designated], not: {segregated: [true]} }
                        - { kind: path, kind_detail: [path], bicycle: yes, foot: [yes, designated], not: {segregated: [true] }}
                        - { kind: path, kind_detail: [path], bicycle: designated, foot: designated, not: {segregated: [true] }}
                        - { kind: path, kind_detail: cycleway, foot: designated, foot: [yes, designated], segregated: [false] }
                        - { kind: [highway, major_road, minor_road], bicycle: use_sidepath }
                draw:
                    lines:
                        width: [[11, 0px], [13, 0.7px], [14, 1.5px], [16, 2px], [19, 4m]]
                        outline:
                            width: [[13, 0px], [14, 0.5px], [16, 0.75px]]

    arrows:
        filter: { oneway: yes, not: { oneway_bicycle: no }, kind: [highway, major_road, minor_road, path, ferry, racetrack, portage_way], $zoom: { min: 17 } }
        data: { source: mapzen, layer: roads }
        draw:
            icons:
                flat: true
                sprite: arrow
                color: '#9370db'
                size: [[17, 7px], [18, 10px], [19, 13px], [20, 15px]]
                placement: spaced
                placement_spacing: [[17, 60px], [18, 30px], [19, 25px], [20, 25px], [21, 25px]]
                angle: auto
                order: 1015
                text:
                    visible: false

    aerialway:
        filter: { kind: aerialway }
        data: { source: mapzen, layer: roads }
        draw:
            lines:
                order: function() { return feature.sort_rank; }
                color: [.5, .5, .5]
                width: [[14, 0.5px], [15, 1.0px], [16, 1.5px]]
            points:
                color: black
                size: [[14, 1px], [15, 4.0px], [16, 6.0px], [17, 7.0px], [18, 8.0px]]

    railway:
        filter: { kind: rail }
        data: { source: mapzen, layer: roads }
        draw:
            lines:
                order: 1200
                color: black
                width: [[10, 0.5px], [12, 1.0px], [13, 1.5px]]
        service:
            filter: { service: true }
            draw:
                lines:
                    width: [[15, 0px], [16, 0.5px], [17, 1.0px]]
        tunnels:
            filter: { is_tunnel: true }
            draw:
                lines:
                    color: gray

    train_station:
        data: { source: mapzen, layer: pois }
        filter:
            kind: [station]
        draw:
            text:
                text_source: global.name_source
                font:
                    weight: 100
                    size: 13px
                    family: Helvetica
                    fill: black
                    stroke: global.text_stroke

    buildings:
        filter: { $zoom: { min: 15 } }
        data: { source: mapzen, layer: buildings }
        draw:
            polygons:
                order: function() { return feature.sort_rank; }
                color: global.building_color
        address-labels:
            filter:
                all:
                    - $zoom: { min: 19 }
                any:
                    - kind: address
                    - { label_position: true, addr_housenumber: true, name: false }
            draw:
                text:
                    order: function() { return feature.sort_rank; }
                    text_source: addr_housenumber
                    font:
                        fill: global.text_fill_color
                        family: global.text_font_family
                        size: 12px
                        stroke: global.text_stroke

    places:
        data: { source: mapzen, layer: places }
        filter:
            all:
                - name: true
                - not: {source: [whosonfirst.mapzen.com]}
                - not: { kind: [region, county, state] }
        draw:
            text:
                text_source: global.name_source
                font:
                    weight: 100
                    size: 13px
                    family: global.text_font_family
                    fill: global.text_fill_color
                    stroke: global.text_stroke
        # nix podunk burgs under z15
        minor-places:
            filter: { kind: [hamlet, village, town, neighbourhood, suburb, quarter], $zoom: { max: 15 } }
            visible: false
        major-places:
            filter: {population: { min: 50000 }}
            draw:
                text:
                    font:
                        size: 21px

    places_from_pois:
        data: { source: mapzen, layer: pois }
        filter:
            kind: [alpine_hut]
        draw:
            text:
                text_source: global.name_source
                font:
                  weight: 100
                  size: 13px
                  family: global.text_font_family
                  fill: global.text_fill_color
                  stroke: global.text_stroke

    bicycle_parking:
        data: { source: mapzen, layer: pois }
        filter:
            kind: [bicycle_parking]
        draw:
            icons:
                size: [[13, 14px], [16, 18px], [18, 19px]]
                sprite: function() { return feature.kind; }
                sprite_default: generic
                priority: 65
                repeat_group: abc
                buffer: 3px
                text:
                    text_source: global.bicycle_parking_text_source
                    buffer: 3px
                    text_wrap: 18
                    max_lines: 3
                    font:
                        family: global.text_font_family
                        weight: normal
                        fill: global.text_fill_color
                        size: [[13, 10px], [14, 11px], [17, 12px], [19, 12px], [20, 14px]]
                        stroke: global.text_stroke
        no-name:
            z17:
                filter:
                    kind: [bicycle_parking]
                draw: { icons: { visible: global.icon_visible_poi_landuse_e } }

    barriers:
        data: { source: mapzen, layer: landuse }
        draw:
            lines:
                order: 910

        generic_barrier:
            filter: { kind: [fence, wall, city_wall, retaining_wall] }
            draw:
                lines:
                    color: '#555555'
                    width: [[16, 0px], [17, 1px], [18, 1.5px], [20, 0.5m]]

        hedge:
            filter: { kind: hedge }
            draw:
                lines:
                    color: [0.239, 0.510, 0.227, 1.00]
                    width: [[16, 0px], [17, 1px], [18, 1.5px], [20, 0.5m]]

    water:
        data: { source: mapzen, layer: water }
        water_lines:
            filter:
                all:
                    - $geometry: line
                    - kind: [river, canal, stream, dam, ditch, drain]
                    - not: {is_tunnel: true}
                any:
                    - $zoom: { min: 13 }
                    - kind: [river, canal]
            draw:
                lines:
                    order: function() { return feature.sort_rank; }
                    color: global.water_color
                    width: [[13, 1px], [14, 1.5px], [15, 2px], [16, 3px], [18, 4m]]
                    cap: round
        water_lines_text:
            filter:
                all:
                    - $geometry: line
                    - kind: [river, canal, stream, dam, ditch, drain]
                    - not: {is_tunnel: true}
                any:
                    - $zoom: { min: 13 }
                    - kind: [river, canal]
            draw:
                text:
                    text_source: global.name_source
                    buffer: 3px
                    text_wrap: 18
                    max_lines: 3
                    font:
                        family: global.text_font_family
                        weight: normal
                        fill: global.water_text_fill_color
                        size: [[16,12px],[17,13px],[19,13px],[20,14px]]
                        stroke: global.text_stroke

        water_areas:
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: global.water_color

    water_names:
        data: { source: mapzen_names, layer: water }
        water_areas_text:
            filter:
              any:
                # show labels for smaller landuse areas at higher zooms
                # low zooms blocked by https://github.com/tilezen/vector-datasource/issues/977
                - { $zoom: { min: 6 },  area: { min: 160000000 }, not: {kind: riverbank} }
                - { $zoom: { min: 7 },  area: { min:  80000000 }, not: {kind: riverbank} }
                - { $zoom: { min: 8 },  area: { min:  40000000 }, not: {kind: riverbank} }
                - { $zoom: { min: 9 },  area: { min:  20000000 }, not: {kind: riverbank} }
                - { $zoom: { min: 10 }, area: { min:  10000000 }, not: {kind: riverbank} }
                - { $zoom: { min: 11 }, area: { min:    800000 }, not: {kind: riverbank} }
                - { $zoom: { min: 12 }, area: { min:    400000 }, not: {kind: riverbank} }
                - { $zoom: { min: 13 }, area: { min:    200000 }, not: {kind: riverbank} }
                - { $zoom: { min: 14 }, area: { min:    100000 }, not: {kind: riverbank} }
                - { $zoom: { min: 15 }, area: { min:     50000 }, not: {kind: riverbank} }
                - { $zoom: { min: 16 }, area: { min:     20000 }, not: {kind: riverbank} }
                - { $zoom: { min: 17 }, area: { min:      1000 }, not: {kind: riverbank} }
                - { $zoom: { min: 18 }, not: {kind: riverbank} }
            draw:
                text:
                    text_source: global.name_source
                    buffer: 3px
                    text_wrap: 18
                    max_lines: 3
                    font:
                        family: global.text_font_family
                        weight: normal
                        fill: global.water_text_fill_color
                        size: [[16,12px], [17,13px], [19,13px], [20,14px]]
                        stroke: global.text_stroke
