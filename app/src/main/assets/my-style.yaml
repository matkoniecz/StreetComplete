# license: GPLv3
# based on
# - reduced https://github.com/tangrams/cinnabar-style (MIT license)
# - https://raw.githubusercontent.com/tangrams/highways-demo/master/scene.yaml from https://github.com/tangrams/highways-demo seems a sane starting point (MIT license)
# https://mapzen.com/tangram/play/ used during development
# https://mapzen.com/documentation/vector-tiles/layers/ documentation of exposed data
#
# make background brown-gray
# render landuse= residential commercial retail industrial railway?
# drop black borders - switch to purple
# make footways purple
# oneway arrows - why displayed on {kind: rail}? Double not is disallowed?

# part of development blocked by missing data
# - access=* - see https://github.com/tilezen/vector-datasource/issues/1273
# - segregated on lower zoom levels - see https://github.com/tilezen/vector-datasource/issues/1316
# - poor bridge recognition - see https://github.com/tilezen/vector-datasource/issues/1314 ( after fixing that https://github.com/tangrams/cinnabar-style/issues/38 will be useful )
# - barrier=wall - see https://github.com/tilezen/vector-datasource/issues/1403
# - labels in local language - see https://github.com/tilezen/vector-datasource/issues/1406

# lessons learned:
# 1) remember about both natural=wood and landuse=forest
global:
    bicycle_parking_text_source: |
        function() {
            return feature.capacity + " " + feature.operator;
        }
    name_source: |
        function() {
            return feature['name:pl'] || feature.name;
        }
    text_stroke: '#e4e1de'
    text_font_family: 'Open Sans'
    pedestrian_color: [0.8, 0.8, 0.8]

textures:
    pois:
        url: images/refill@2x.png
        filtering: mipmap
        sprites:
            bicycle_parking: [644, 126, 38, 38]
            arrow: [368, 210, 38, 38]

sources:
    mapzen:
        type: TopoJSON #GeoJSON, MVT, TopoJSON
        url:  https://tile.mapzen.com/mapzen/vector/v1/all/{z}/{x}/{y}.topojson
        max_zoom: 20

camera:
    type: isometric

styles:
    icons:
        base: points
        texture: pois
        blend_order: 1

fonts:
    Open Sans:
        - weight: 300 # Light
          url: fonts/OpenSans-Light.woff
        - weight: normal # Regular
          url: fonts/OpenSans-Regular.woff
        - weight: normal # Regular
          style: italic
          url: fonts/OpenSans-Italic.woff
        - weight: 600 # Semi Bold
          url: fonts/OpenSans-Semibold.woff
        - weight: 600 # Semi Bold
          style: italic
          url: fonts/OpenSans-SemiboldItalic.woff
        - weight: bold
          url: fonts/OpenSans-Bold.woff

scene:
    background:
        color: '#faf4f4'

layers:
    landuse:
        data: { source: mapzen, layer: landuse }
        forested_area:
            filter: { kind: [park, forest, natural_wood] }
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    # tone down green as you zoom out
                    color: [[10, '#b6e79f'], [14,  '#a4e187']]
        playgrounds:
            filter: { kind: [playground] }
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: [0.780, 0.973, 0.737, 1.00]
        pitches:
            filter: { kind: [pitch] }
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: [0.973, 0.965, 0.737, 1.00]

        pedestrian:
            filter:
                kind: [pedestrian,common,footway]
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: global.pedestrian_color

    path:
        data: { source: mapzen, layer: roads }
        filter:
            any:
                - { kind_detail: [footway, path, steps], not: { bicycle: designated }, not: { bicycle: yes }, $zoom: { min: 13 } }
                - { kind_detail: [pedestrian], not: { bicycle: designated }, not: { bicycle: yes }, $zoom: { min: 13 }}
        draw:
            lines:
                order: 1100
                color: global.pedestrian_color
                width: [[16, 0], [17, 2m]]
                cap: round
        walking_routes:
            filter: {walking_network: true}
            draw:
                lines:
                    width: [[1, 4px], [17, 2m]]

    roads:
        data: { source: mapzen, layer: roads }
        filter: { not: { kind_detail: service, kind: rail } }
        highway:
            filter:
                any:
                    - { kind: path, kind_detail: [footway, path], bicycle: designated }
                    - { kind: path, kind_detail: [footway, path], bicycle: yes }
                    - { kind: path, kind_detail: cycleway }
                    - { kind: path, kind_detail: track }
                    - { kind_detail: [pedestrian], bicycle: designated }
                    - { kind_detail: [pedestrian], bicycle: yes }
                    - kind: [highway, major_road, minor_road]
            draw:
                lines:
                    order: 1300
                    color: white
                    cap: round
                    width: [[1, 1.5px], [14, 2.5px], [16, 2.5px], [19, 6m]]
                    outline:
                        order: 1010
                        color: black
                        width: [[14, 1px], [15, 1.5px]]
                        cap: butt
            highway_names:
                filter: { $zoom: { min: 16 } }
                draw:
                    text:
                        text_source: global.name_source
                        buffer: 3px
                        text_wrap: 18
                        max_lines: 3
                        font:
                            family: global.text_font_family
                            weight: normal
                            fill: [0.20,0.20,0.20]
                            size: [[16,12px],[17,13px],[19,13px],[20,14px]]
                            stroke: { color: global.text_stroke, width: [[12,2px],[16,4px]] }
            tunnel:
                filter: {is_tunnel: true, $zoom: {min: 17} }
                draw:
                    lines:
                        outline:
                            width: [[17, 3px], [18, 4px]]
                            color: [.5, .5, .5]
            good_surface:
                filter: {surface: [asphalt, paved, wood, metal, tartan, metal_grid]}
                draw:
                    lines:
                        color: [0.941, 0.843, 1.000, 1.00]
                        order: 1201
            medium_surface:
                filter: {surface: [concrete, paving_stones, compacted, sett]}
                draw:
                    lines:
                        color: [0.965, 0.922, 0.988, 1.00]
                        order: 1011
            bad_surface:
                filter: {surface: [unpaved, dirt, earth, fine_gravel, grass, grass_paver, gravel,
                ground, mud, pebblestone, salt, sand, woodchips, clay, cobblestone,
                cobblestone:flattened, concrete:lanes, concrete:plates, artificial_turf, decoturf]}
                draw:
                    lines:
                        width: [[1, 0.5px], [14, 1.5px], [16, 1.5px], [19, 4m]]
                        color: [0.83, 0.83, 0.83]
                        order: 1200
                        outline:
                            order: 1010
                            width: [[1, 0.5px], [16, 0.75px]]
            missing_surface:
                filter: {not: {surface: [asphalt, paved, wood, metal, tartan, metal_grid,
                concrete, paving_stones, compacted, sett,
                unpaved, dirt, earth, fine_gravel, grass, grass_paver, gravel,
                ground, mud, pebblestone, salt, sand, woodchips, clay, cobblestone,
                cobblestone:flattened, concrete:lanes, concrete:plates, artificial_turf, decoturf]}}
                draw:
                    lines:
                        width: [[1, 0.5px], [14, 1.5px], [16, 1.5px], [19, 5m]]
                        color: white
                        order: 1200
                        outline:
                            order: 1010
                            width: [[1, 0.5px], [16, 0.75px]]
            unimportant_service:
                filter: { service: [driveway, parking_aisle, 'drive-through'] }
                draw:
                    lines:
                        width: [[11, 0px], [13, 0.5px], [14, 1.5px], [16, 1.5px], [19, 5px]]
                        order: 1199
            unsegregated_or_use_sidepath:
                filter:
                    any:
                        - { kind: path, kind_detail: [footway], bicycle: [yes, designated], not: {segregated: [true]} }
                        - { kind: path, kind_detail: [path], bicycle: yes, foot: [yes, designated], not: {segregated: [true] }}
                        - { kind: path, kind_detail: [path], bicycle: designated, foot: designated, not: {segregated: [true] }}
                        - { kind: path, kind_detail: cycleway, foot: designated, foot: [yes, designated], segregated: [false] }
                        - { kind: [highway, major_road, minor_road], bicycle: use_sidepath }
                draw:
                    lines:
                        width: [[11, 0px], [13, 0.7px], [14, 1.5px], [16, 2px], [19, 4m]]
                        outline:
                            order: 1010
                            width: [[13, 0px], [14, 0.5px], [16, 0.75px]]

    arrows:
        filter: { oneway: yes, not: { oneway_bicycle: no }, not: { kind: rail }, $zoom: { min: 17 } }
        data: { source: mapzen, layer: roads }
        draw:
            icons:
                flat: true
                sprite: arrow
                color: 'black'
                size: [[17, 7px], [20, 14px]]
                placement: spaced
                placement_spacing: [[20, 175px], [17, 70px]]
                angle: auto
                text:
                    visible: false

    aerialway:
        filter: { kind: aerialway }
        data: { source: mapzen, layer: roads }
        draw:
            lines:
                order: function() { return feature.sort_rank; }
                color: [.5, .5, .5]
                width: [[14, 0.5px], [15, 1.0px], [16, 1.5px]]
            points:
                color: black
                size: [[14, 1px], [15, 4.0px], [16, 6.0px], [17, 7.0px], [18, 8.0px]]

    railway:
        filter: { kind: rail }
        data: { source: mapzen, layer: roads }
        draw:
            lines:
                order: function() { return feature.sort_rank; }
                color: black
                width: [[10, 0.5px], [12, 1.0px], [13, 1.5px]]
        service:
            filter: { service: true }
            draw:
                lines:
                    width: [[15, 0px], [16, 0.5px], [17, 1.0px]]
        tunnels:
            filter: { is_tunnel: true }
            draw:
                lines:
                    color: gray

    train_station:
        data: { source: mapzen, layer: pois }
        filter:
            kind: [station]
        draw:
            text:
                text_source: global.name_source
                font:
                    weight: 100
                    size: 13px
                    family: Helvetica
                    fill: black
                    stroke: { color: global.text_stroke, width: [[1,2px], [12,3px],[16,4px]] }

    buildings:
        filter: { $zoom: { min: 15 } }
        data: { source: mapzen, layer: buildings }
        draw:
            polygons:
                order: function() { return feature.sort_rank; }
                color: [.5, .5, .5]

    places:
        data: { source: mapzen }
        filter: { name: true, not: { kind: [region, county, state] } }
        draw:
            text:
                text_source: global.name_source
                font:
                    weight: 100
                    size: 13px
                    family: Helvetica
                    fill: black
                    stroke: { color: global.text_stroke, width: [[1,2px], [12,3px],[16,4px]] }
        # nix podunk burgs under z15
        minor-places:
            filter: { kind: [hamlet, village, town, neighbourhood, suburb, quarter], $zoom: { max: 15 } }
            visible: false
        major-places:
            filter: {population: { min: 50000 }}
            draw:
                text:
                    font:
                        size: 21px

    bicycle_parking:
        data: { source: mapzen, layer: pois }
        filter:
            kind: [bicycle_parking]
        draw:
            icons:
                size: [[13, 14px], [16, 18px], [18, 19px]]
                sprite: function() { return feature.kind; }
                sprite_default: generic
                priority: 65
                repeat_group: abc
                buffer: 3px
                text:
                    text_source: global.bicycle_parking_text_source
                    buffer: 3px
                    text_wrap: 18
                    max_lines: 3
                    font:
                        family: global.text_font_family
                        weight: normal
                        fill: [0.20,0.20,0.20]
                        size: [[13,10px],[14,11px],[17,12px],[19,12px],[20,14px]]
                        stroke: { color: global.text_stroke, width: [[12,2px],[16,4px]] }
        no-name:
            z17:
                filter:
                    kind: [bicycle_parking]
                draw: { icons: { visible: global.icon_visible_poi_landuse_e } }

    barriers:
        data: { source: mapzen, layer: landuse }
        draw:
            lines:
                order: 1000

        generic_barrier:
            filter: { kind: [fence, wall, city_wall, retaining_wall] }
            draw:
                lines:
                    color: '#555555'
                    width: [[16, 0px], [17, 1px], [18, 1.5px], [20, 0.5m]]

        hedge:
            filter: { kind: hedge }
            draw:
                lines:
                    color: [0.239, 0.510, 0.227, 1.00]
                    width: [[16, 0px], [17, 1px], [18, 1.5px], [20, 0.5m]]

    water:
        data: { source: mapzen, layer: water }
        lines:
            filter: { kind: [river,canal,stream,dam,ditch,drain], $zoom: { min: 13 } }
            draw:
                lines:
                    order: function() { return feature.sort_rank; }
                    color: [0.267, 0.635, 0.898, 1.00]
                    width: [[13,1px],[14,1.5px],[15,2px],[16,3px],[18,4m]]
                    cap: round

        water_areas:
            draw:
                polygons:
                    order: function() { return feature.sort_rank; }
                    color: [0.267, 0.635, 0.898, 1.00]
